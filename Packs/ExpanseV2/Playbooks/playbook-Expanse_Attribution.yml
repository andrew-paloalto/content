id: Expanse Attribution
version: -1
name: Expanse Attribution
description: |
  Subplaybook for Handle Expanse Incident playbooks. Given an Expanse Issue IP, Issue Provider, Issue Domain,
  Issue Port and Issue Protocol hunts for internal activity related to the detected service.
  The playbook looks for logs on Splunk, Cortex Data Lake, Panorama, and ServiceNow CMDB.
  Returns a list of potential owner BUs, owner Users, Device and Notes.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 1439e55f-e456-4e7e-80c5-6bb9fd3ade7a
    type: start
    task:
      id: 1439e55f-e456-4e7e-80c5-6bb9fd3ade7a
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
      - "10"
      - "17"
      - "53"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 490,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "2":
    id: "2"
    taskid: 646c51b3-64a3-4cc4-8c9e-0c300eeb3cec
    type: title
    task:
      id: 646c51b3-64a3-4cc4-8c9e-0c300eeb3cec
      version: -1
      name: Splunk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -460,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "3":
    id: "3"
    taskid: ba2b6065-cee1-47de-8a94-c134e97a1e35
    type: title
    task:
      id: ba2b6065-cee1-47de-8a94-c134e97a1e35
      version: -1
      name: User Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "31"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "4":
    id: "4"
    taskid: 5959a088-b1f0-45de-86d2-9e4f2eecab4c
    type: regular
    task:
      id: 5959a088-b1f0-45de-86d2-9e4f2eecab4c
      version: -1
      name: Splunk Hunt For Users To IP
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      app: {}
      batch_limit: {}
      earliest_time:
        complex:
          root: inputs.NumberOfDaysInThePast
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: '-'
              suffix:
                value:
                  simple: d
      event_limit:
        simple: "100"
      latest_time: {}
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: dest_ip=
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' transport='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' action=allowed user!="unknown" | top limit=5 user by serial_number,
                    vsys'
      update_context: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -230,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "5":
    id: "5"
    taskid: 7512f4b8-fee1-42c4-8188-1dfc92119376
    type: regular
    task:
      id: 7512f4b8-fee1-42c4-8188-1dfc92119376
      version: -1
      name: Splunk Hunt For Unknown Users To IP
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      app: {}
      batch_limit: {}
      earliest_time:
        complex:
          root: inputs.NumberOfDaysInThePast
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: '-'
              suffix:
                value:
                  simple: d
      event_limit:
        simple: "100"
      latest_time: {}
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: dest_ip=
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' transport='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' action=allowed user="unknown" | top limit=5 src_ip by
                    serial_number, vsys'
      update_context: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 180,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "6":
    id: "6"
    taskid: af011f43-cb0f-42bc-8760-6dfc5c0f84db
    type: condition
    task:
      id: af011f43-cb0f-42bc-8760-6dfc5c0f84db
      version: -1
      name: Is Splunk Enabled?
      description: Check if Splunk integration is enabled
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "5"
      - "4"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: SplunkPy
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": -460,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "10":
    id: "10"
    taskid: a2264d52-e070-491b-8478-c7baccfe1537
    type: title
    task:
      id: a2264d52-e070-491b-8478-c7baccfe1537
      version: -1
      name: Cortex Data Lake
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 930,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "11":
    id: "11"
    taskid: 7343f74e-c5f3-4fe7-8af1-1ce8116a721d
    type: condition
    task:
      id: 7343f74e-c5f3-4fe7-8af1-1ce8116a721d
      version: -1
      name: Is Cortex Data Lake Enabled?
      description: Check if Cortex Data Lake is enabled
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "35"
      "yes":
      - "13"
      - "12"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Cortex Data Lake
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": 930,
          "y": 340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "12":
    id: "12"
    taskid: 4cae6181-ae73-429d-8869-c8b708bf7c05
    type: regular
    task:
      id: 4cae6181-ae73-429d-8869-c8b708bf7c05
      version: -1
      name: Cortex Data Lake Hunt for Unknown Users To IP
      description: Runs a query on  any table or field.
      script: '|||cdl-query-logs'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      ignore-outputs:
        simple: "false"
      limit:
        simple: "100"
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: SELECT source_ip.value AS src_ip,log_source_id,vsys,COUNT(*)
                    AS count FROM `firewall.traffic` WHERE dest_ip.value="
              suffix:
                value:
                  simple: '" AND source_user is NULL AND action.id=0 AND log_time
                    > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.NumberOfDaysInThePast
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' DAY) AND protocol.value=LOWER("'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '") AND dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' GROUP BY log_source_id, vsys, src_ip'
      transform_results:
        simple: "No"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1410,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "13":
    id: "13"
    taskid: 20bed384-92c1-4a86-87be-96bedf01e903
    type: regular
    task:
      id: 20bed384-92c1-4a86-87be-96bedf01e903
      version: -1
      name: Cortex Data Lake Hunt for Users To IP
      description: Runs a query on  any table or field.
      script: '|||cdl-query-logs'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      ignore-outputs:
        simple: "false"
      limit:
        simple: "100"
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: SELECT source_user,log_source_id,vsys,COUNT(*) AS count
                    FROM `firewall.traffic` WHERE dest_ip.value="
              suffix:
                value:
                  simple: '" AND action.id=0 AND source_user is NOT NULL AND log_time
                    > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.NumberOfDaysInThePast
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '  DAY) AND protocol.value=LOWER("'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '") AND dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' GROUP BY log_source_id,vsys,source_user'
      transform_results:
        simple: "No"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 905,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "17":
    id: "17"
    taskid: eab774c4-02c5-4dee-8965-fa202810606e
    type: title
    task:
      id: eab774c4-02c5-4dee-8965-fa202810606e
      version: -1
      name: Panorama
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "18":
    id: "18"
    taskid: 1d247655-3be4-49c8-899a-15f11a15f417
    type: condition
    task:
      id: 1d247655-3be4-49c8-899a-15f11a15f417
      version: -1
      name: Is Panorama Enabled?
      description: Check if Panorama/PAN-OS is enabled
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "36"
      "yes":
      - "25"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Panorama
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "21":
    id: "21"
    taskid: 3f5eb80c-04e9-47ce-8f0d-5d2e9e6645fb
    type: playbook
    task:
      id: 3f5eb80c-04e9-47ce-8f0d-5d2e9e6645fb
      version: -1
      name: Panorama Query Logs
      description: 'Query Panorama Logs of types: traffic, threat, url, data-filtering
        and wildfire.'
      playbookName: Panorama Query Logs
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "47"
    scriptarguments:
      action: {}
      addr-dst: {}
      addr-src: {}
      filedigest: {}
      ip: {}
      log_type:
        simple: traffic
      port-dst: {}
      query:
        complex:
          root: inputs.Protocol
          transformers:
          - operator: toLowerCase
          - operator: concat
            args:
              prefix:
                value:
                  simple: '(proto eq '
              suffix:
                value:
                  simple: ') and (addr.dst in '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.IP
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ') and (action eq allow) and (user.src eq '''') and (port.dst
                    eq '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: )
      rule: {}
      time-generated: {}
      url: {}
      zone-dst: {}
      zone-src: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "25":
    id: "25"
    taskid: 5724da04-6f04-461c-8217-d6f5928dc032
    type: playbook
    task:
      id: 5724da04-6f04-461c-8217-d6f5928dc032
      version: -1
      name: Panorama Query Logs
      description: 'Query Panorama Logs of types: traffic, threat, url, data-filtering
        and wildfire.'
      playbookName: Panorama Query Logs
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      action: {}
      addr-dst: {}
      addr-src: {}
      filedigest: {}
      ip: {}
      log_type:
        simple: traffic
      port-dst: {}
      query:
        complex:
          root: inputs.Protocol
          transformers:
          - operator: toLowerCase
          - operator: concat
            args:
              prefix:
                value:
                  simple: '(proto eq '
              suffix:
                value:
                  simple: ') and (addr.dst in '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.IP
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ') and (action eq allow) and (user.src neq '''') and (port.dst
                    eq '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: )
      rule: {}
      time-generated: {}
      url: {}
      zone-dst: {}
      zone-src: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "30":
    id: "30"
    taskid: f5900a2f-c528-4a74-84f9-e3473ad79b94
    type: title
    task:
      id: f5900a2f-c528-4a74-84f9-e3473ad79b94
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 3150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "31":
    id: "31"
    taskid: 78ff62a9-0182-4eac-803c-d16e93196663
    type: condition
    task:
      id: 78ff62a9-0182-4eac-803c-d16e93196663
      version: -1
      name: Do We Have Users?
      description: Check if AD is enabled & we have users to enrich
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "38"
      "yes":
      - "52"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThan
          left:
            value:
              complex:
                root: Expanse.AttributionUser
                accessor: username
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "0"
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "33":
    id: "33"
    taskid: 468166de-d649-4626-8e85-9a16cac2820f
    type: regular
    task:
      id: 468166de-d649-4626-8e85-9a16cac2820f
      version: -1
      name: Export Enriched Users
      description: Expanse Enrich Attribution Data Structure with additional details
      scriptName: ExpanseEnrichAttribution
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      current:
        simple: ${Expanse.AttributionUser}
      enrich:
        simple: ${ActiveDirectory.Users}
      enrich_fields:
        simple: memberOf=groups,description,manager,mail
      enrich_key:
        simple: sAMAccountName
      type:
        simple: User
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1010,
          "y": 2160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "34":
    id: "34"
    taskid: e826a536-3ecf-4eba-8af6-e69322ca318f
    type: title
    task:
      id: e826a536-3ecf-4eba-8af6-e69322ca318f
      version: -1
      name: Splunk Not Enabled
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "46"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -820,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "35":
    id: "35"
    taskid: 50de6c15-5bcf-47ad-8946-730982cabf74
    type: title
    task:
      id: 50de6c15-5bcf-47ad-8946-730982cabf74
      version: -1
      name: Cortex Data Lake Not Enabled
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 620,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "36":
    id: "36"
    taskid: e6698f2f-7e70-45fd-814e-b6fe3fe8be94
    type: title
    task:
      id: e6698f2f-7e70-45fd-814e-b6fe3fe8be94
      version: -1
      name: Panorama Not Enabled
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "47"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2390,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "38":
    id: "38"
    taskid: 203873ac-6000-4ebf-8c01-7b4cea78bff9
    type: title
    task:
      id: 203873ac-6000-4ebf-8c01-7b4cea78bff9
      version: -1
      name: Device Enrichmnent
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 2400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "39":
    id: "39"
    taskid: 15374bf1-b96b-4d8c-8b92-8129f0b99dca
    type: condition
    task:
      id: 15374bf1-b96b-4d8c-8b92-8129f0b99dca
      version: -1
      name: Is Panorama Enabled And We Have Devices?
      description: Check if Panorama/PAN-OS is enabled & we have device to enrich
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "40"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              simple: modules.brand
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              simple: modules.brand
            iscontext: true
          right:
            value:
              simple: Panorama
      - - operator: isEqualString
          left:
            value:
              simple: modules.state
            iscontext: true
          right:
            value:
              simple: active
      - - operator: greaterThan
          left:
            value:
              complex:
                root: Expanse.AttributionDevice
                accessor: serial
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "0"
    view: |-
      {
        "position": {
          "x": 580,
          "y": 2550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "40":
    id: "40"
    taskid: 704ab9bd-71f0-4768-8265-8e3283d51b22
    type: regular
    task:
      id: 704ab9bd-71f0-4768-8265-8e3283d51b22
      version: -1
      name: Retrieve Device Groups
      description: Run any command supported in the API.
      script: '|||panorama'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      action: {}
      category: {}
      cmd:
        simple: <show><devicegroups></devicegroups></show>
      command: {}
      dst: {}
      element: {}
      extend-context:
        simple: PanoramaDeviceGroup=response.result.devicegroups.entry
      from: {}
      ignore-outputs:
        simple: "true"
      job-id: {}
      key: {}
      log-type: {}
      pcap-id: {}
      period: {}
      query: {}
      reportname: {}
      reporttype: {}
      search-time: {}
      serialno: {}
      target: {}
      to: {}
      type:
        simple: op
      where: {}
      xpath: {}
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 2740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "41":
    id: "41"
    taskid: 6daa4e71-3bde-45b0-85a8-4b9447720265
    type: regular
    task:
      id: 6daa4e71-3bde-45b0-85a8-4b9447720265
      version: -1
      name: Enrich Attribution Device
      description: Expanse Enrich Attribution Data Structure with additional details
      scriptName: ExpanseEnrichAttribution
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      current:
        simple: ${Expanse.AttributionDevice}
      enrich:
        complex:
          root: PanoramaDeviceGroup
          transformers:
          - operator: jmespath
            args:
              expression:
                value:
                  simple: '{deviceGroup: "@name", serial: to_array(devices.entry)[].serial}'
      enrich_fields:
        simple: deviceGroup=device-group
      enrich_key:
        simple: serial
      type:
        simple: Device
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 2920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "45":
    id: "45"
    taskid: d7964216-2ecf-4e3c-8c77-23f3ee498442
    type: title
    task:
      id: d7964216-2ecf-4e3c-8c77-23f3ee498442
      version: -1
      name: Cortex Data Lake Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1185,
          "y": 925
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "46":
    id: "46"
    taskid: 64d3829b-15d8-47a1-8165-1fbbcf4ff65b
    type: title
    task:
      id: 64d3829b-15d8-47a1-8165-1fbbcf4ff65b
      version: -1
      name: Splunk Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -45,
          "y": 735
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "47":
    id: "47"
    taskid: 6151cafa-c70e-4b8f-80ee-8ad32e083efa
    type: title
    task:
      id: 6151cafa-c70e-4b8f-80ee-8ad32e083efa
      version: -1
      name: Panorama Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 925
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "48":
    id: "48"
    taskid: c6917ada-79c9-43d7-8c7c-5d8cad1f3f0c
    type: title
    task:
      id: c6917ada-79c9-43d7-8c7c-5d8cad1f3f0c
      version: -1
      name: Aggregation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "49"
      - "50"
      - "51"
      - "56"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1295
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "49":
    id: "49"
    taskid: fd445e11-8442-4cad-8879-f99732253316
    type: regular
    task:
      id: fd445e11-8442-4cad-8879-f99732253316
      version: -1
      name: Aggregate Attribution Device Result
      description: Aggregate entries from multiple sources into AttributionDevice
      scriptName: ExpanseAggregateAttributionDevice
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        complex:
          root: Expanse
          accessor: AttributionDevice
      input:
        complex:
          root: Splunk
          accessor: Result
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: CDL.Logging
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Panorama.Monitor.Logs
                iscontext: true
      internal_ip_networks: {}
      serial_fields:
        simple: serial_number,serial,log_source_id,DeviceSN
      sightings_fields: {}
      source_ip_fields: {}
      vsys_fields:
        simple: vsys,Vsys
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "50":
    id: "50"
    taskid: 3cf82cb9-59b5-43e7-8df0-59416245ebd0
    type: regular
    task:
      id: 3cf82cb9-59b5-43e7-8df0-59416245ebd0
      version: -1
      name: Aggregate Attribution IP Result
      description: Aggregate entries from multiple sources into AttributionIP
      scriptName: ExpanseAggregateAttributionIP
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        complex:
          root: Expanse
          accessor: AttributionIP
      input:
        complex:
          root: Splunk
          accessor: Result
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: CDL.Logging
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Panorama.Monitor.Logs
                iscontext: true
      internal_ip_networks: {}
      sightings_fields: {}
      source_ip_fields:
        simple: src,src_ip,SourceAddress
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "51":
    id: "51"
    taskid: 7e6e4115-0b5a-4658-872f-dea3a8dc0f40
    type: regular
    task:
      id: 7e6e4115-0b5a-4658-872f-dea3a8dc0f40
      version: -1
      name: Aggregate Attribution User Result
      description: Aggregate entries from multiple sources into AttributionUser
      scriptName: ExpanseAggregateAttributionUser
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        complex:
          root: Expanse
          accessor: AttributionUser
      input:
        complex:
          root: Splunk
          accessor: Result
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: CDL.Logging
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Panorama.Monitor.Logs
                iscontext: true
      sightings_fields: {}
      username_fields:
        simple: source_user,srcuser,user,SourceUser
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 985,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "52":
    id: "52"
    taskid: 9b8c9779-c75c-4cfb-8361-558943b7bb8d
    type: playbook
    task:
      id: 9b8c9779-c75c-4cfb-8361-558943b7bb8d
      version: -1
      name: Account Enrichment - Generic v2.1
      playbookName: Account Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      Username:
        complex:
          root: Expanse.AttributionUser
          accessor: username
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1010,
          "y": 1980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "53":
    id: "53"
    taskid: 2a1409dd-8bf3-4f2d-8586-1205199245c3
    type: title
    task:
      id: 2a1409dd-8bf3-4f2d-8586-1205199245c3
      version: -1
      name: ServiceNow CMDB
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "55"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2860,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "54":
    id: "54"
    taskid: 136717cd-ee46-4716-8781-53765a010e8d
    type: title
    task:
      id: 136717cd-ee46-4716-8781-53765a010e8d
      version: -1
      name: ServiceNow CMDB Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2860,
          "y": 925
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "55":
    id: "55"
    taskid: a022fb4b-d884-444c-81dc-5057d0358b44
    type: playbook
    task:
      id: a022fb4b-d884-444c-81dc-5057d0358b44
      version: -1
      name: Expanse Check ServiceNow CMDB
      playbookName: Expanse Check ServiceNow CMDB
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "54"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 2860,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "56":
    id: "56"
    taskid: bd34cb36-0258-460d-82b2-bbea5275d639
    type: regular
    task:
      id: bd34cb36-0258-460d-82b2-bbea5275d639
      version: -1
      name: ExpanseAggregateAttributionCI
      description: Aggregate entries from ServiceNow CMDB into AttributionCI
      scriptName: ExpanseAggregateAttributionCI
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        simple: ${Expanse.AttributionCI}
      input:
        simple: ${ServiceNowCMDB.Report}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1400,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 3165,
        "width": 4060,
        "x": -820,
        "y": 50
      }
    }
  }
inputs:
- key: IP
  value:
    simple: ${incident.expanseip}
  required: true
  description: Expanse Issue IP.
  playbookInputQuery:
- key: Domain
  value:
    simple: ${incident.expansedomain}
  required: false
  description: Expanse Issue Domain.
  playbookInputQuery:
- key: Provider
  value:
    simple: ${incident.expanseprovider}
  required: false
  description: Expanse Issue Provider.
  playbookInputQuery:
- key: Port
  value:
    simple: ${incident.expanseport}
  required: true
  description: Expanse Issue Port.
  playbookInputQuery:
- key: Protocol
  value:
    simple: ${incident.expanseprotocol}
  required: true
  description: Expanse Issue Protocol.
  playbookInputQuery:
- key: InternalIPRange
  value: {}
  required: false
  description: 'A list of internal IP ranges to check IP addresses against. The list
    should be provided in CIDR format, separated by commas. An example of a list of
    ranges could be: 172.16.0.0/12,10.0.0.0/8,192.168.0.0/16. If a list of IP ranges
    is not provided, the list provided in the IsIPInRanges script (the known IPv4
    private address ranges) is used by default.'
  playbookInputQuery:
- key: NumberOfDaysInThePast
  value:
    simple: "7"
  required: false
  description: Number of days to look back to for logs.
  playbookInputQuery:
outputs:
- contextPath: Expanse.AttributionIP
  description: IP addresses
  type: unknown
- contextPath: Expanse.AttributionDevice
  description: Devices
  type: unknown
- contextPath: Expanse.AttributionUser
  description: Users
  type: Unknown
- contextPath: Expanse.AttributionCI
  description: CMDB CI
  type: Unknown
tests:
- No tests
fromversion: 6.0.0
